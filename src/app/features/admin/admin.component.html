<div class="admin-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <i class="bi bi-shield-lock-fill me-2"></i>
      <span>Admin Panel</span>
    </div>
    <nav class="sidebar-nav">
      <a href="/admin" class="sidebar-link">
        <i class="bi bi-box-seam"></i>
        <span>Products</span>
      </a>
      <a href="/customer" class="sidebar-link">
        <i class="bi bi-people"></i>
        <span>Customers</span>
      </a>
      <a href="#" class="sidebar-link">
        <i class="bi bi-receipt"></i>
        <span>Orders</span>
      </a>
      <a href="#" class="sidebar-link">
        <i class="bi bi-tag"></i>
        <span>Categories</span>
      </a>
      <a href="#" class="sidebar-link">
        <i class="bi bi-gear"></i>
        <span>Settings</span>
      </a>
    </nav>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
      <div class="container-fluid">
        <span class="navbar-brand fw-bold mb-0">Product Management</span>
        <div class="d-flex align-items-center">
          <span class="text-muted me-3">
            <i class="bi bi-person-circle me-2"></i>
            {{ userEmail }}
          </span>
          <button class="btn btn-outline-danger btn-sm" (click)="logout()">
            <i class="bi bi-box-arrow-right me-2"></i>
            Logout
          </button>
        </div>
      </div>
    </nav>

    <!-- Content -->
    <div class="container-fluid">
      <!-- Success/Error Messages -->
      <div
        *ngIf="successMessage"
        class="alert alert-success alert-dismissible fade show"
        role="alert"
      >
        <i class="bi bi-check-circle-fill me-2"></i>
        {{ successMessage }}
        <button
          type="button"
          class="btn-close"
          (click)="successMessage = ''"
          aria-label="Close"
        ></button>
      </div>

      <div
        *ngIf="errorMessage"
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
      >
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ errorMessage }}
        <button
          type="button"
          class="btn-close"
          (click)="errorMessage = ''"
          aria-label="Close"
        ></button>
      </div>

      <!-- Product Management Section -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
          <div class="row align-items-center">
            <div class="col-md-6">
              <h4 class="mb-0">
                <i class="bi bi-box-seam me-2"></i>
                Product Management
              </h4>
            </div>
            <div class="col-md-6 text-end">
              <button class="btn btn-primary" (click)="openCreateModal()">
                <i class="bi bi-plus-circle me-2"></i>
                Add New Product
              </button>
            </div>
          </div>
        </div>

        <div class="card-body">
          <!-- Search and Filter Bar -->
          <div class="row mb-3">
            <div class="col-md-5">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search products..."
                  [(ngModel)]="searchTerm"
                  (keyup.enter)="onSearch()"
                />
                <button class="btn btn-outline-secondary" (click)="onSearch()">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-center">
                <label class="me-2 text-muted small">Sort by:</label>
                <select
                  class="form-select form-select-sm"
                  [(ngModel)]="sortBy"
                  (ngModelChange)="onSortChange()"
                >
                  <option value="name">Name</option>
                  <option value="price">Price</option>
                  <option value="createdAt">Newest</option>
                </select>
                <button
                  class="btn btn-sm btn-outline-secondary ms-2"
                  (click)="toggleSortDirection()"
                  [class.active]="isDescending"
                >
                  <span *ngIf="isDescending">▼ Desc</span>
                  <span *ngIf="!isDescending">▲ Asc</span>
                </button>
              </div>
            </div>
            <div class="col-md-3 text-end">
              <small class="text-muted">
                Showing {{ products.length }} of {{ totalItems }} products
              </small>
            </div>
          </div>

          <!-- Products Table -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th style="width: 80px">Image</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th style="width: 120px">Price</th>
                  <th style="width: 150px">Category</th>
                  <th style="width: 180px" class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Loading State -->
                <tr *ngIf="isLoading">
                  <td colspan="6" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading products...</p>
                  </td>
                </tr>

                <!-- Empty State -->
                <tr *ngIf="!isLoading && products.length === 0">
                  <td colspan="6" class="text-center py-5">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="mt-3 text-muted">No products found</p>
                    <button
                      class="btn btn-primary btn-sm"
                      (click)="openCreateModal()"
                    >
                      <i class="bi bi-plus-circle me-2"></i>
                      Add First Product
                    </button>
                  </td>
                </tr>

                <!-- Product Rows -->
                <tr *ngFor="let product of products">
                  <td>
                    <img
                      [src]="
                        product.mainImageUrl ||
                        'https://via.placeholder.com/80x80?text=No+Image'
                      "
                      [alt]="product.name"
                      class="product-thumbnail"
                    />
                  </td>
                  <td>
                    <strong
                      class="text-truncate d-inline-block"
                      style="max-width: 200px"
                      [title]="product.name"
                    >
                      {{ product.name }}
                    </strong>
                  </td>
                  <td>
                    <span class="text-muted">
                      {{
                        product.description || "No description" | slice : 0 : 50
                      }}
                      <span
                        *ngIf="
                          product.description && product.description.length > 50
                        "
                        >...</span
                      >
                    </span>
                  </td>
                  <td>
                    <strong class="text-success"
                      >${{ product.price | number : "1.2-2" }}</strong
                    >
                  </td>
                  <td>
                    <span class="badge bg-secondary">{{
                      product.categoryName || "Unknown"
                    }}</span>
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                      <button
                        class="btn btn-outline-primary"
                        (click)="openEditModal(product)"
                        title="Edit"
                      >
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button
                        class="btn btn-outline-danger"
                        (click)="openDeleteModal(product)"
                        title="Delete"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <nav *ngIf="totalPages > 1" class="mt-4">
            <ul class="pagination justify-content-center">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <button class="page-link" (click)="goToPage(currentPage - 1)">
                  Previous
                </button>
              </li>
              <li
                *ngFor="let page of [].constructor(totalPages); let i = index"
                class="page-item"
                [class.active]="currentPage === i + 1"
              >
                <button class="page-link" (click)="goToPage(i + 1)">
                  {{ i + 1 }}
                </button>
              </li>
              <li
                class="page-item"
                [class.disabled]="currentPage === totalPages"
              >
                <button class="page-link" (click)="goToPage(currentPage + 1)">
                  Next
                </button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Product Modal -->
<div
  class="modal"
  [class.show]="showCreateModal"
  [style.display]="showCreateModal ? 'block' : 'none'"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle me-2"></i>
          Create New Product
        </h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeCreateModal()"
        ></button>
      </div>
      <form [formGroup]="productForm" (ngSubmit)="createProduct()">
        <div class="modal-body">
          <!-- Product Name -->
          <div class="mb-3">
            <label for="createName" class="form-label">Product Name *</label>
            <input
              type="text"
              class="form-control"
              id="createName"
              formControlName="name"
              placeholder="Enter product name"
              [class.is-invalid]="
                productForm.get('name')?.invalid &&
                productForm.get('name')?.touched
              "
            />
            <div
              class="invalid-feedback"
              *ngIf="
                productForm.get('name')?.invalid &&
                productForm.get('name')?.touched
              "
            >
              <span *ngIf="productForm.get('name')?.errors?.['required']"
                >Product name is required</span
              >
              <span *ngIf="productForm.get('name')?.errors?.['minlength']"
                >Name must be at least 3 characters</span
              >
            </div>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label for="createDescription" class="form-label"
              >Description</label
            >
            <textarea
              class="form-control"
              id="createDescription"
              formControlName="description"
              rows="3"
              placeholder="Enter product description"
            ></textarea>
          </div>

          <!-- Price -->
          <div class="mb-3">
            <label for="createPrice" class="form-label">Price *</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input
                type="number"
                class="form-control"
                id="createPrice"
                formControlName="price"
                step="0.01"
                min="0"
                placeholder="0.00"
                [class.is-invalid]="
                  productForm.get('price')?.invalid &&
                  productForm.get('price')?.touched
                "
              />
              <div
                class="invalid-feedback"
                *ngIf="
                  productForm.get('price')?.invalid &&
                  productForm.get('price')?.touched
                "
              >
                <span *ngIf="productForm.get('price')?.errors?.['required']"
                  >Price is required</span
                >
                <span *ngIf="productForm.get('price')?.errors?.['min']"
                  >Price must be greater than 0</span
                >
              </div>
            </div>
          </div>

          <!-- Category -->
          <div class="mb-3">
            <label for="createCategory" class="form-label">Category *</label>
            <select
              class="form-select"
              id="createCategory"
              formControlName="categoryId"
              [class.is-invalid]="
                productForm.get('categoryId')?.invalid &&
                productForm.get('categoryId')?.touched
              "
            >
              <option value="" disabled selected hidden>
                Select a category
              </option>
              <option *ngFor="let category of categories" [value]="category.id">
                {{ category.name }}
              </option>
            </select>
            <div
              class="invalid-feedback"
              *ngIf="
                productForm.get('categoryId')?.invalid &&
                productForm.get('categoryId')?.touched
              "
            >
              Category is required
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeCreateModal()"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="productForm.invalid || isLoading"
          >
            <span *ngIf="!isLoading">
              <i class="bi bi-check-circle me-2"></i>
              Create Product
            </span>
            <span *ngIf="isLoading">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Creating...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div
  class="modal"
  [class.show]="showEditModal"
  [style.display]="showEditModal ? 'block' : 'none'"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil me-2"></i>
          Edit Product
        </h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeEditModal()"
        ></button>
      </div>
      <form [formGroup]="productForm" (ngSubmit)="updateProduct()">
        <div class="modal-body">
          <!-- Product Name -->
          <div class="mb-3">
            <label for="editName" class="form-label">Product Name *</label>
            <input
              type="text"
              class="form-control"
              id="editName"
              formControlName="name"
              [class.is-invalid]="
                productForm.get('name')?.invalid &&
                productForm.get('name')?.touched
              "
            />
            <div
              class="invalid-feedback"
              *ngIf="
                productForm.get('name')?.invalid &&
                productForm.get('name')?.touched
              "
            >
              <span *ngIf="productForm.get('name')?.errors?.['required']"
                >Product name is required</span
              >
              <span *ngIf="productForm.get('name')?.errors?.['minlength']"
                >Name must be at least 3 characters</span
              >
            </div>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label for="editDescription" class="form-label">Description</label>
            <textarea
              class="form-control"
              id="editDescription"
              formControlName="description"
              rows="3"
            ></textarea>
          </div>

          <!-- Price -->
          <div class="mb-3">
            <label for="editPrice" class="form-label">Price *</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input
                type="number"
                class="form-control"
                id="editPrice"
                formControlName="price"
                step="0.01"
                min="0"
                [class.is-invalid]="
                  productForm.get('price')?.invalid &&
                  productForm.get('price')?.touched
                "
              />
              <div
                class="invalid-feedback"
                *ngIf="
                  productForm.get('price')?.invalid &&
                  productForm.get('price')?.touched
                "
              >
                <span *ngIf="productForm.get('price')?.errors?.['required']"
                  >Price is required</span
                >
                <span *ngIf="productForm.get('price')?.errors?.['min']"
                  >Price must be greater than 0</span
                >
              </div>
            </div>
          </div>

          <!-- Note: Category cannot be changed on update -->
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <small>Note: Category cannot be changed after creation.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeEditModal()"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="productForm.invalid || isLoading"
          >
            <span *ngIf="!isLoading">
              <i class="bi bi-check-circle me-2"></i>
              Update Product
            </span>
            <span *ngIf="isLoading">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Updating...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  class="modal"
  [class.show]="showDeleteModal"
  [style.display]="showDeleteModal ? 'block' : 'none'"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Confirm Delete
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="closeDeleteModal()"
        ></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this product?</p>
        <div *ngIf="selectedProduct" class="alert alert-warning">
          <strong>Product:</strong> {{ selectedProduct.name }}<br />
          <strong>Price:</strong> ${{
            selectedProduct.price | number : "1.2-2"
          }}
        </div>
        <p class="text-muted small mb-0">
          <i class="bi bi-info-circle me-2"></i>
          This action cannot be undone.
        </p>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeDeleteModal()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-danger"
          (click)="deleteProduct()"
          [disabled]="isLoading"
        >
          <span *ngIf="!isLoading">
            <i class="bi bi-trash me-2"></i>
            Delete Product
          </span>
          <span *ngIf="isLoading">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Deleting...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div
  class="modal-backdrop fade"
  [class.show]="showCreateModal || showEditModal || showDeleteModal"
  *ngIf="showCreateModal || showEditModal || showDeleteModal"
></div>
